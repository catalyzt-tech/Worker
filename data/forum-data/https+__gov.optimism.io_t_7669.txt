{
  "title": "Upgrade Proposal #5: Ecotone Network Upgrade",
  "content": "EXECUTIVE SUMMARY\n\nHi I’m Roberto, an engineer on the core Base team and a core developer of the OP\nStack. Neither Coinbase nor I represent or speak on behalf of the Optimism\nFoundation.\n\nThis is a proposal for the Ecotone network upgrade, which adopts EIP-4844 blobs\nfor data availability and activates Dencun L1 extensions. Blobs are a new type\nof data storage introduced by Dencun specifically for the purpose of rollup data\navailability. Blob data is priced using a separate fee market from regular\ntransaction gas, and is purely additive to calldata (batches in Ecotone can be\nposted using either). We expect a dramatic (up to ~80x) reduction in overall\ntransaction fees due to the fact that blobs increase data availability capacity\nto 4x of what all L2s use today. The remaining changes in this upgrade bring the\ncore improvements from the L1 Dencun hardfork into the OP stack, including new\nopcodes and the beacon root support. While blob data availability requires L1\nDencun activation, the Ecotone upgrade can be activated independently of it.\n\n\nSPECIFICATIONS\n\n\nTECHNICAL SPECIFICATION\n\nWe propose the Ecotone network upgrade which activates:\n\n * EIP-4844 Blobs for Data Availability\n   * Chain derivation support for transaction batches posted to the L1 as\n     EIP-4844 blobs. (spec\n     [https://specs.optimism.io/protocol/derivation.html#ecotone-blob-retrieval])\n   * A new L1 data fee pricing function to accommodate the impact of blobs on\n     data availability cost (spec\n     [https://specs.optimism.io/protocol/exec-engine.html#ecotone-l1-cost-fee-changes-eip-4844-da]).\n     * An upgraded GasPriceOracle L2 predeploy to compute it (spec\n       [https://specs.optimism.io/protocol/predeploys.html#gaspriceoracle])\n     * An upgraded L1Block predeploy to process the function’s new parameters\n       provided by an updated L1 attributes transaction (spec\n       [https://specs.optimism.io/protocol/deposits.html#l1-attributes---ecotone])\n * Dencun\n   * EIP-4788 [https://eips.ethereum.org/EIPS/eip-4788]: Expose beacon chain\n     roots through the execution layer block header and EVM. (spec\n     [https://specs.optimism.io/protocol/exec-engine.html#ecotone-beacon-block-root])\n   * EIP-1153 [https://eips.ethereum.org/EIPS/eip-1153]: Transient storage\n     opcode support (TLOAD, TSTORE).\n   * EIP-5656 [https://eips.ethereum.org/EIPS/eip-5656]: Memory copy opcode\n     support (MCODE).\n   * EIP-6780 [https://eips.ethereum.org/EIPS/eip-6780]: Self-destruct\n     (SELFDESTRUCT) limited to the same transaction only.\n   * EIP-4844 [https://eips.ethereum.org/EIPS/eip-4844] is the only Dencun\n     execution feature not activated in Ecotone. Blob transactions are instead\n     explicitly disabled, and the BLOBBASEFEE opcode from EIP-7516\n     [https://eips.ethereum.org/EIPS/eip-7516], while activated, always returns\n     1. (spec\n     [https://specs.optimism.io/protocol/exec-engine.html#ecotone-disable-blob-transactions])\n * The Ecotone hardfork activation block, which includes several transactions to\n   perform all L2 contract deployments, upgrades, enablements, and proxy\n   updates. (spec [https://specs.optimism.io/protocol/derivation.html#ecotone])\n\n\nSECURITY CONSIDERATIONS\n\nConsistent with the OP Labs Audit Framework\n[https://gov.optimism.io/t/op-labs-audit-framework-when-to-get-external-security-review-and-how-to-prepare-for-it/6864],\nwe did not have the contents of Ecotone audited; however Coinbase and OP Labs\nengineers did perform a security review of these changes.\n\nThe Dencun upgrade consists of relatively standard EVM changes and the\nintroduction of beacon block root in the block header and a beacon roots\ncontract deployed at a special location. We consider the EVM changes low risk\nbecause they have been active on Goerli and Sepolia testnets without issue. We\nhave also entirely disabled the new transaction type (blob transactions)\nintroduced by EIP-4844 from being accepted by the L2 chain.\n\nWhile blobs are disabled in the L2, Ecotone supports posting transaction batches\nto the L1 using blobs. This extension affects chain derivation, adding new logic\naround interpreting blob transactions posted by the batcher, downloading any\nreferenced blobs from an L1 consensus client, and processing their contents by\ndecoding them from the blob format to the usual channel format. We consider\nthese changes medium risk primarily because of the larger scope of the change.\nThese changes do not affect bridging or any L1 contracts, and are therefore\nunlikely to introduce bugs that can be exploited to drain assets.\n\nThe introduction of the new L1 data fee cost function required updates to two of\nthe L2 predeploy contracts, GasPriceOracle and L1Block, and also changes to both\nop-node and op-geth to compute the fee values and propagate the appropriate fee\nparameters. The contract extensions were required to pass the new Blob base fee\nderived from L1 blocks to the L2 so that it is aware of the blob fee market, and\nso that developers could use the GasPriceOracle to compute the new data fee\nwithout having to roll their own implementation of the new function (details\nhere [https://docs.optimism.io/builders/notices/ecotone-fee-changes]). These\nchanges are limited to a few short functions. Because of the overall scope of\nthis change, we consider it medium risk. The most severe faults from these\nchanges might be a chain halt due to a chain derivation/validation failure, or\nunder/over payment for L1 data fees by users. Significant underpayment could\nresult in revenue loss for the chain operator, but the system provides\nparameters that can be updated quickly via the SystemConfig in order to quickly\ncompensate for such scenarios.\n\nOne final potential risk is the introduction of a special Ecotone upgrade block\nwhich introduces special deposit transactions that perform the various contract\ndeployments and upgrades on the L2. Bugs in this code could lead to an\nincomplete fork with missing contracts or contract functionality expected by the\nupgrade, in the worst case leading to chain halt. We have tested the upgrade\nprocess on several devnets and the Base and OP-goerli testnets with success, and\noverall consider the changes medium risk.\n\n\nIMPACT SUMMARY\n\nWe do not anticipate any down time due to this upgrade.\n\nBringing Dencun to the OP Stack is important to retain compatibility with\nEthereum. One Dencun change to be aware of is the new behavior of the\nSELFDESTRUCT opcode, which may be backwards incompatible for some contracts. We\nexpect the number of affected contracts to be small since the change has been\nlong telegraphed by L1 developers. The beacon root feature introduced by Dencun\nwill allow L2 contracts to validate L1 consensus data, and should support new\nuse cases involving staking pools and re-staking.\n\nWe expect the greatest impact of Ecotone to come from using blobs for\ntransaction batching. Blobs are a new type of L1 data storage introduced by\nDencun specifically for the purpose of rollup data availability. Blob data is\npriced using a separate fee market from regular transaction gas, and is purely\nadditive to calldata (batches in Ecotone can be posted using either). It’s\ndifficult to precisely estimate the impact of this feature on transaction fees\nsince we cannot predict new use cases that might arise to consume them. Based on\nthe data availability use case alone, however, capacity increases to 4x what all\nL2s are using today. While blobspace is uncongested, we expect up to ~80x\nreduction in fees for all OP chains as long as blobs are fully utilized.\nPrediction markets are currently estimating a 40x cost reduction in the short\nterm.\n\nBlob usage is optional and configurable by the chain operator in Ecotone. Lower\ntraffic chains may choose not to enable them since achieving maximum benefits\nmay require far less frequent posting of data to the L1. While blob usage\nrequires Dencun activation on the L1, Ecotone can be activated independently of\nit should the benefits of its other features be desired earlier.\n\n\nACTION PLAN\n\nIf this vote passes, the Ecotone upgrade will be scheduled for execution on\nMarch 14th at 00:00:01 UTC**. The upgrade will occur automatically for nodes on\na release which contains the baked in activation time. Ecotone is code complete\nin the optimism monorepo at commit f707883038d527cbf1e9f8ea513fe33255deadbc and\nop-geth at commit 0402d543c3d0cff3a3d344c0f4f83809edb44f10. The op-node release\nv1.7.0 and op-geth release v1.101308.2 contain these changes.*\n\nIn the event governance vetoes the upgrade, we will release a new version of the\nop-node and op-geth software with the activation date removed.\n\nThis upgrade has already been activated on internal devnets in coordination with\nBase & Conduit. It successfully activated on op-goerli and base-goerli on Feb 6,\nwith Sepolia scheduled for Feb 21.\n\nIf there is a critical security issue, node operators will be able to disable\nthe upgrade by using the --override.ecotone flag on both op-node & op-geth.\nCoinbase and OP Labs will also collaborate with the community to extensively\ncommunicate that the upgrade is no longer happening.\n\nWe will release a new version of op-node & op-geth with the mainnet Ecotone\nactivation date baked in and publicize to node operators & end users that the\nEcotone upgrade will be occurring. The mainnet ecotone activation date is\nscheduled for March 14th at 00:00:01 UTC.\n\n\nCONCLUSION\n\nThis proposal outlines the network upgrade after Delta titled Ecotone. This\nnetwork upgrade maintains EVM equivalence via activating the Dencun network\nupgrade and allows OP Stack to take advantage of L1 blob data for lower cost\ndata availability.\n\nWe expect that this upgrade will not result in any down time and will occur on\nMarch 14th.\n\n*This proposal was updated to reference op-node v1.7.0.\n\n**A previous revision proposed an upgrade date of March 18th 17:00:00 UTC.",
  "views": 4815,
  "like_count": 73,
  "word_count": 2452,
  "answer": [
    {
      "content": "EIP-4844 support is an important upgrade, and it’s prudent to prioritize it as\ncompetitors like Arbitrum and zkSync will support it from day 1 (March 13th)\n\nI am an Optimism Delegate [https://vote.optimism.io/delegate/polynya.eth] with\nsufficient voting power and I believe this proposal is ready to move to a vote.",
      "created_at": "2024-02-21T23:10:42.032Z",
      "trust_level": 2,
      "username": "polynya",
      "admin": false,
      "moderator": false,
      "staff": false,
      "like_count": 10
    },
    {
      "content": "I’m glad to see that the necessary work has already been completed to adopt\nEIP-4844.\n\nI am an Optimism delegate with sufficient voting power\n[https://vote.optimism.io/delegates/joxes.eth] and I believe this proposal is\nready to move to a vote.",
      "created_at": "2024-02-22T14:53:14.041Z",
      "trust_level": 2,
      "username": "Joxes",
      "admin": false,
      "moderator": false,
      "staff": false,
      "like_count": 7
    },
    {
      "content": "Let’s blob!\n\nI am an Optimism delegate [https://vote.optimism.io/delegates/0xdonpepe.eth]with\nsufficient voting power and I believe this proposal is ready to move to a vote.",
      "created_at": "2024-02-22T14:29:01.555Z",
      "trust_level": 2,
      "username": "0xDonPepe",
      "admin": false,
      "moderator": false,
      "staff": false,
      "like_count": 5
    },
    {
      "content": "I’m an Optimism delegate\n[https://gov.optimism.io/t/pgov-delegate-communication-thread/6059]with\nsufficient voting power and I believe this proposal is ready to move to a vote.",
      "created_at": "2024-02-22T02:30:11.379Z",
      "trust_level": 3,
      "username": "PGov",
      "admin": false,
      "moderator": false,
      "staff": false,
      "like_count": 4
    },
    {
      "content": "We’re voting FOR this proposal.\n\nWe support the update of OP Mainnet to post data to this new Ethereum instance\n(blobspace). For years, the entire community has eagerly awaited and\ncomprehended the benefits for the UX side that EIP-4844 offer, while security\ndesigns have been carefully taken into account by so many development teams.\nAdditionally, we agree it is appropriate for OP Mainnet to follow the latest\nEthereum mainnet specifications by adopting and adapting almost all the\nintroduced changes.\n\nLast, just a quick note to say congratulations on the excellent communication\neffort to promote the benefits of the proposed update through the website\nhttps://welovetheblobs.xyz/ [https://welovetheblobs.xyz/]. Well done!",
      "created_at": "2024-03-04T01:33:24.358Z",
      "trust_level": 2,
      "username": "Joxes",
      "admin": false,
      "moderator": false,
      "staff": false,
      "like_count": 3
    }
  ],
  "created_at": "2024-02-14T23:54:30.541Z"
}