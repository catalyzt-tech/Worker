{
  "title": "[FINAL] Upgrade Proposal #2: Canyon Network Upgrade",
  "content": "EXECUTIVE SUMMARY\n\nHi I’m Joshua, an engineer at OP Labs. OP Labs is a software development company\nfocused on the Optimism ecosystem, and a core developer of the OP Stack. We\nprovide some services to, but do not represent or speak on behalf of, the\nOptimism Foundation.\n\nUpgrade #2, Canyon is the first proposed network upgrade after Bedrock. Canyon\ncontains the Shapella network upgrade from Ethereum, a change to reduce the\nvolatility of the basefee, and several minor bug fixes. The Canyon upgrade will\nmaintain EVM equivalence & improve the ergonomics of using the OP Stack for\ndevelopers and end users. In addition, node operators will need to upgrade their\nnodes to stay in sync. Canyon brings the OP Stack protocol version to v4.0.0.\n\nIf this vote passes, Canyon will activate on op-mainnet, base-mainnet,\npgn-mainnet, & zora-mainnet on Thu Jan 11 17:00:01 UTC 2024 (Unix Time\n1704992401) barring a critical security issue. All op-node versions after v1.3.1\n& all op-geth versions after v1.101304.1 are compatible with Canyon. We will\nrelease a new version of op-node & op-geth with the Canyon activation time baked\nin if the vote passes governance.\n\n\nSPECIFICATIONS\n\n\nTECHNICAL SPECIFICATION\n\nWe are activating the following features as part of the Canyon upgrade. Full\nCanyon Specification\n[https://github.com/ethereum-optimism/optimism/blob/develop/specs/superchain-upgrades.md#canyon]\nin Github.\n\n * Shapella\n   * EIP-3651: Warm COINBASE [https://eips.ethereum.org/EIPS/eip-3651]\n   * EIP-3855: PUSH0 instruction [https://eips.ethereum.org/EIPS/eip-3855]\n   * EIP-3860: Limit and meter initcode\n     [https://eips.ethereum.org/EIPS/eip-3860]\n   * EIP-4895: Beacon chain push withdrawals as operations\n     [https://eips.ethereum.org/EIPS/eip-4895]\n   * EIP-6049: Deprecate SELFDESTRUCT [https://eips.ethereum.org/EIPS/eip-6049]\n   * Prohibit withdrawals in OP Stack blocks\n     * P2P Spec\n       [https://github.com/ethereum-optimism/optimism/blob/develop/specs/rollup-node-p2p.md#block-validation]\n     * Block Building Spec\n       [https://github.com/ethereum-optimism/optimism/blob/develop/specs/derivation.md#building-individual-payload-attributes]\n * EIP-1559 Parameter Changes\n   * Increasing EIP-1559 Denominator from 50 to 250\n   * Specification\n     [https://github.com/ethereum-optimism/optimism/blob/develop/specs/exec-engine.md#1559-parameters]\n * Adjust Channel Ordering\n   * The first ready channel is now read rather than the first channel when it\n     is ready\n   * Specification\n     [https://github.com/ethereum-optimism/optimism/blob/develop/specs/derivation.md#reading]\n * Receipt Hash Change\n   * The deposit nonce is included in the deposit receipt hash\n   * Specification\n     [https://github.com/ethereum-optimism/optimism/blob/develop/specs/deposits.md#deposit-receipt]\n * create2Deployer\n   * We are deploying standardized bytecode to\n     0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF2\n   * Specification\n     [https://github.com/ethereum-optimism/optimism/blob/develop/specs/predeploys.md#create2deployer]\n\n\nSECURITY CONSIDERATIONS\n\nConsistent with the OP Labs Audit Framework\n[https://gov.optimism.io/t/op-labs-audit-framework-when-to-get-external-security-review-and-how-to-prepare-for-it/6864],\nOP Labs did not have the contents of Canyon audited; however OP Labs did perform\na security review of these changes.\n\nThe Shapella L1 upgrade consists of relatively standard EVM changes & the\naddition of beacon chain withdrawals. OP Labs considers the EVM changes low risk\nbecause they have been active on L1 without issue. Withdrawals are a new L1\ncodepath to create arbitrary mints in the EVM. OP Labs has ensured that this\ntype of transaction cannot occur on L2…\n\nThe next set of changes, EIP-1559 config change, the channel ordering change,\nand the receipt hash change also are low risk changes. They do not modify any\ncode path which is responsible for securing user funds and have been tested.\n\nThe last change, the create2Deployer, presents a larger user facing change.\nCanyon unconditionally modifies the bytecode of the\n0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF2 address. This address already has the\ncreate2Deployer on it on some, but not all, networks. OP Labs has validated that\nthe contract code deployed by Canyon matches the public ABI of the existing\ncontract. This upgrade does remove portions of the admin ABI (pausing, ownable),\nbut OP Labs has confirmed that the contract author is ok with removing the\nOwnable & Pausable functionality. A typical developer would not be able to call\nthese functions.\n\n\nIMPACT SUMMARY\n\nOP Labs does not anticipate any down time due to this upgrade. This network\nupgrade does not contain backwards incompatible changes for end users.\n\nShapella is important to retain compatibility with Ethereum. One change to be\naware of is the deprecation warning of the SELFDESTRUCT opcode. The behavior of\nthe opcode is not changing in Canyon, but is expected to change in a future\nnetwork upgrade. Ethereum is expected to implement EIP-6780\n[https://eips.ethereum.org/EIPS/eip-6780] in the Dencun network upgrade to\nmodify this opcode, and the Optimism community should expect to follow this\nchange in the spirit of EVM equivalence.\n\nThe EIP-1559 Denominator will be changing from 50 to 250. OP Labs is proposing\nthis change to decrease volatility in the basefee on the OP Stack. By increasing\nthe denominator, the amount the basefee increases is reduced when the gas used\nis over the gas target. A denominator of 50 was initially chosen for Bedrock\nsuch that the basefee on the OP Stack would decrease at approximately a rate of\n-12% per 12s when the block were completely empty. This matches the decrease of\nEthereum’s basefee. The rate of increase with completely full blocks was 77%\nover 12s because the gas limit on the OP Stack is 6x the gas target. Since\nBedrock, 2 minutes of full congestion (30m gas blocks) on the OP Stack would\nresult in an increased base fee of ****304x ****(1.1^60) ******vs 2 minutes of\nfull congestion on L1 Ethereum would result in an increased base fee of 3.24x\n(1.125^10). OP Labs is suggesting a denominator of 250 to match the rate of\nincrease of Ethereum when OP Stack blocks are completely full. This will also\nreduce how quickly the basefee decays when blocks are empty and will enable\nusers to have their transactions included more easily during periods of high\nusage.\n\nCanyon modifies the protocol to handle unclosed channels. Previously, only a\nsingle channel could be active at a time and if the channel was not closed, it\nwould need to time out before progress could resume. Following the upgrade, the\nop-node will read the first channel that is ready.\n\nA new field will be added to the deposit transaction receipt encoding. It\nmodifies the encoding to fix a bug where the deposit transaction nonce was not\nin consensus encoding.\n\nFinally, Canyon sets the create2Deployer bytecode at\n0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF2 on all OP networks. This enables\ndevelopers to have access to this commonly used contract on all OP networks, not\njust OP Mainnet. This also particularly helps users on Base mainnet, where, due\nto a deployment issue, the create2Deployer is not able to be deployed to this\naddress. Block explorers may have to re-verify the create2Deployer contract.\n\n\nACTION PLAN\n\nIf this vote passes, the Canyon upgrade will be schedule for execution 5\n****weeks after the vote passes, on Thu Jan 11 17:00:01 UTC 2024. The upgrade\nwill occur automatically for nodes on a release which contains the baked in\nactivation time. Canyon is code complete in the optimism monorepo at commit\n6cce3728b7bed5e36234aeba3b773e0f97867be3 and op-geth at commit\ned8e9f54ed0a5069e77ea34895ff12a9ac4ca17f. The op-node release v1.3.1 and op-geth\nrelease v1.101304.1 contain these changes. These commits do not contain the\nCanyon timestamp for mainnet. These releases could be used on mainnet by using\nthe --override.canyon flag. OP Labs will release a future version of op-node &\nop-geth with the Canyon time configured if governance approves this upgrade.\n\nThis upgrade has already been activated on internal devnets in coordination with\nBase & Conduit. It successfully activated on op-goerli, op-sepolia, base-goerli,\nbase-sepolia, pgn-sepolia, & zora-sepolia on November 14 at 17:00:00 UTC.\n\nIf there is a critical security issue, node operators will be able to disable\nthe upgrade by using the —override.canyon flag on both op-node & op-geth. OP\nLabs will also collaborate with the community to extensively communicate that\nthe upgrade is no longer happening.\n\nOP Labs will release a new version of op-node & op-geth with the Canyon\nactivation date baked in and publicize to node operators & end users that the\nCanyon upgrade will be occurring.\n\n\nCONCLUSION\n\nThis proposal outlines the Optimism Collective’s first network upgrade after\nBedrock titled Canyon. This network upgrade maintains EVM equivalence via\nactivating the Shapella network upgrade and includes several OP Stack specific\nimprovements.\n\nWe expect that this upgrade will not result in any down time and will occur at\nThu Jan 11 17:00:01 UTC 2024.",
  "views": 5047,
  "like_count": 45,
  "word_count": 2698,
  "answer": [
    {
      "content": "There is no need to go through a governance process to implement Canyon; all new\nConduit chains will activate Canyon.",
      "created_at": "2023-11-29T13:20:56.912Z",
      "trust_level": 4,
      "username": "lavande",
      "admin": true,
      "moderator": true,
      "staff": true,
      "like_count": 3
    },
    {
      "content": "I am a delegate with sufficient voting weight Delegate Commitments [OLD] - #71\nby MoneyManDoug [https://gov.optimism.io/t/delegate-commitments-old/235/71] I\nbelieve this proposal is ready for voting.",
      "created_at": "2023-11-20T16:37:22.362Z",
      "trust_level": 2,
      "username": "MoneyManDoug",
      "admin": false,
      "moderator": false,
      "staff": false,
      "like_count": 3
    },
    {
      "content": "\n[https://avatars.discourse-cdn.com/v4/letter/t/ecc23a/48.png] trianglesphere:\n\n> ny down time due to this upgrade. This network upgrade does not contain\n> backwards incompatible changes for end users.\n> \n> Shapella is important to retain compatibility with Ethereum. One change to be\n> aware of is the deprecation warning of the SELFDESTRUCT opcode. The behavior\n> of the opcode is not changing in Canyon, but is expected to change in a future\n> network upgrade. Ethereum is expected to implement EIP-6780\n> [https://eips.ethereum.org/EIPS/eip-6780] in the Dencun network upgrade to\n> modify this opcode, and the Optimism community should expect to follow this\n> change in the spirit of EVM equivalence.\n> \n> The EIP-1559 Denominator will be changing from 50 to 250. OP Labs is proposing\n> this change to decrease volatility in the basefee on the OP Stack. By\n> increasing the denominator, the amount the basefee increases is reduced when\n> the gas used is over the gas target. A denominator of 50 was initially chosen\n> for Bedrock such that the basefee on the OP Stack would decrease at\n> approximately a rate of -12% per 12s when the block were completely empty.\n> This matches the decrease of Ethereum’s basefee. The rate of increase with\n> completely full blocks was 77% over 12s because the gas limit on the OP Stack\n> is 6x the gas target. Since Bedrock, 2 minutes of full congestion (30m gas\n> blocks) on the OP Stack would result in an increased base fee of ****304x\n> ****(1.1^60) ******vs 2 minutes of full congestion on L1 Ethereum would result\n> in an increased base fee of 3.24x (1.125^10). OP Labs is suggesting a\n> denominator of 250 to match the rate of increase of Ethereum when OP Stack\n> blocks are completely full. This will also reduce how quickly the basefee\n> decays when blocks are empty and will enable users to have their transactions\n> included more easily during periods of high usage.\n> \n> Canyon modifies the protocol to handle unclosed channels. Previously, only a\n> single channel could be active at a time and if the channel was not closed, it\n> would need to time out before progress could resume. Following the upgrade,\n> the op-node will read the first channel that is ready.\n> \n> A new field will be added to the deposit transaction receipt encoding. It\n> modifies the encoding to fix a bug where the deposit transaction nonce was not\n> in consensus encoding.\n> \n> Finally, Canyon sets the create2Deployer bytecode at\n> 0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF2 on all OP networks. This enables\n> developers to have access to this commonly used contract on all OP networks,\n> not just OP Mainnet. This also particularly helps users on Base mainnet,\n> where, due to a deployment issue, the create2Deployer is not able to be\n> deployed to this address. Block explorers may have to re-verify the\n> create2Deployer contract.\n> \n> \n> ACTION PLAN\n> \n> If this vote passes, the Canyon upgrade will be schedule for execution 5\n> ****weeks after the vote passes, on Thu Jan 11 17:00:01 UTC 2024. The upgrade\n> will occur automatically for nodes on a release which contains the baked in\n> activation time. Canyon is code complete in the optimism monorepo at commit\n> 6cce3728b7bed5e36234aeba3b773e0f97867be3 and op-geth at commit\n> ed8e9f54ed0a5069e77ea34895ff12a9ac4ca17f. The op-node release v1.3.1 and\n> op-geth release v1.101304.1 contain these changes. These commits do not\n> contain the Canyon timestamp for mainnet. These releases could be used on\n> mainnet by using the --override.canyon flag. OP Labs will release a future\n> version of op-node & op-geth with the Canyon time configured if governance\n> approves this upgrade.\n> \n> This upgrade has already been activated on internal devnets in coordination\n> with Base & Conduit. It successfully activated on op-goerli, op-sepolia,\n> base-goerli, base-sepolia, pgn-sepolia, & zora-sepolia on November 14 at\n> 17:00:00 UTC.\n> \n> If there is a critical security issue, node operators will be able to disable\n> the upgrade by using the —override.canyon flag on both op-node & op-geth. OP\n> Labs will also collaborate with the community to extensively communicate that\n> the upgrade is no longer happening.\n> \n> OP Labs will release a new version of op-node & op-geth with the Canyon\n> activation date baked in and publicize to node operators & end users that the\n> Canyon upgrade will be occurring.\n\nHey @trianglesphere [/u/trianglesphere] we are thrilled at the additional level\nof scalability brought about by the Canyon Network Upgrade! The Lyra Chain has\nrecently been deployed ahead of the V2 launch of the Lyra Protocol. Is it\npossible to include Lyra Chain in this proposal and the scheduled upgrades?\n\n[https://europe1.discourse-cdn.com/bc41dd/original/2X/2/2c5fb1505d0f0a374a64299077768bde2fe8fe3d.png]\nmirror.xyz\n[https://mirror.xyz/lyra.eth/TWH07KhC61fLdMEfZ_TOkBpZPA6HFFqg0F9zvSL5R2Y]\n[https://europe1.discourse-cdn.com/bc41dd/optimized/2X/a/aac5a3b9d66f236c1a58549cdb674b4a729a4e93_2_690x345.jpeg]\n\n\nLYRA CHAIN: HARDER, BETTER, FASTER, STRONGER\n[https://mirror.xyz/lyra.eth/TWH07KhC61fLdMEfZ_TOkBpZPA6HFFqg0F9zvSL5R2Y]\n\nWe know Lyra V2 is coming. We know it’s made for pro traders. And we know it’s\nthe most scalable derivatives protocol yet. But how did we build it all onchain?\nIt’s time to find out how we leveraged the OP Stack to build Lyra Chain and make\nus\n\n\n",
      "created_at": "2023-11-21T23:57:54.136Z",
      "trust_level": 2,
      "username": "ksett",
      "admin": false,
      "moderator": false,
      "staff": false,
      "like_count": 3
    },
    {
      "content": "I voted for this proposal after getting a second opinion from my Scalar\ncolleague Jordan Clifford as we didn’t see any major issues.",
      "created_at": "2023-11-29T05:27:37.261Z",
      "trust_level": 2,
      "username": "linda",
      "admin": false,
      "moderator": false,
      "staff": false,
      "like_count": 3
    },
    {
      "content": "We are a delegate with enough voting power and believe this is appropriate for a\nvote in the upcoming cycle.",
      "created_at": "2023-11-17T18:36:20.645Z",
      "trust_level": 3,
      "username": "PGov",
      "admin": false,
      "moderator": false,
      "staff": false,
      "like_count": 2
    }
  ],
  "created_at": "2023-11-14T17:13:28.832Z"
}